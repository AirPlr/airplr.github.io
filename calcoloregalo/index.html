<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calcolatore Regali</title>
  <style>
    :root{--bg:#fbfbfd;--card:#fff;--muted:#6b7280;--accent:#0066cc;--accent-2:#0b74de}
    body{font-family:Inter,Segoe UI,system-ui,Roboto,Arial,sans-serif;background:var(--bg);color:#111;margin:24px;padding:0}
    .container{max-width:980px;margin:0 auto;padding:20px}
    h1{margin:0 0 8px 0;font-weight:600}
    .note,.hint{color:var(--muted);font-size:0.95rem}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(20,20,40,0.06);margin-top:14px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    label{display:block;margin-top:10px;font-size:0.95rem}
    .field{display:flex;gap:8px;align-items:center}
    input[type=number], select{padding:10px;border:1px solid #e6e6e9;border-radius:8px;width:100%}
    .row{display:flex;gap:12px;align-items:center}
    button{margin-top:12px;padding:10px 14px;border:none;background:var(--accent);color:#fff;border-radius:8px;cursor:pointer}
    button[type=button]{background:#666;padding:8px 10px}
    .result{margin-top:12px;font-weight:700;font-size:1rem;white-space:pre-wrap}
    .ev-list label{display:block;margin:6px 0}
    #guest-list .guest-row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .small-btn{padding:6px 8px;border-radius:6px;background:#eee;border:none;cursor:pointer}
    @media(max-width:880px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card grid">
      <div>
        <h1>Calcolatore Regali</h1>
        <p class="hint">Questa pagina usa la stessa formula di riferimento. Seleziona i parametri, gli eventi e premi "Calcola".</p>

        <div class="card" style="margin-top:10px">
          <label>Numero Bambini (B)
            <input id="B" type="number" min="0" value="0">
          </label>

          <label>Numero Adulti (I)
            <input id="I" type="number" min="0" value="0">
          </label>

          <label>Costo del ristorante per persona (C)
            <input id="C" type="number" min="0" step="0.01" value="0">
          </label>

          <label>Grado di Parentela (P)
            <select id="P">
              <option value="1.5">-- Fratello/Sorella --</option>
              <option value="2.0">-- Genitore --</option>
              <option value="1.8">-- Nonno/Nonna --</option>
              <option value="1.5">-- Zio/Zia --</option>
              <option value="1.2">-- Cugino/Cugina --</option>
              <option value="1.0">-- Amico --</option>
            </select>
          </label>

          <label>Grado di 'Bella Figura' (D)
            <select id="D">
              <option value="1.5">-- Massimo --</option>
              <option value="1.3">-- Medio --</option>
              <option value="1.2">-- Sufficiente --</option>
              <option value="1.0">-- Normale --</option>
            </select>
          </label>

          <fieldset class="ev-list" style="margin-top:12px;padding:10px;border-radius:6px;border:1px solid #eee">
            <legend>Tipologie di evento</legend>
            <label><input type="checkbox" value="battesimo" class="ev"> Battesimo</label>
            <label><input type="checkbox" value="matrimonio" class="ev"> Matrimonio</label>
            <label><input type="checkbox" value="compleanno" class="ev"> Compleanno (normale)</label>
            <label><input type="checkbox" value="compleanno18" class="ev"> Compleanno (18 anni)</label>
            <label><input type="checkbox" value="comunione" class="ev"> Comunione</label>
            <label><input type="checkbox" value="cresima" class="ev"> Cresima</label>
          </fieldset>

          <fieldset id="birthday-data" style="margin-top:12px;padding:10px;border-radius:6px;border:1px dashed #ddd; display:none">
            <legend>Dati invitati per i compleanni</legend>
            <div id="guest-list"></div>
            <div style="margin-top:8px">
              <button id="add-guest" type="button">Aggiungi invitato</button>
              <button id="clear-guests" type="button">Svuota invitati</button>
            </div>
            <div class="hint" style="margin-top:8px">Per ogni invitato inserisci età e se ha un lavoro.</div>
          </fieldset>

          <div class="row">
            <button id="calc">Calcola</button>
            <button id="reset" type="button">Reset</button>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <h3>Risultato</h3>
          <div class="result" id="result">Risultato: —</div>
          <div class="note" style="margin-top:12px">Come aggiungere opzioni: modifica il file e aggiorna le select <code>P</code> e <code>D</code>.</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
    const $ = id => document.getElementById(id);

    // Helper: arrotonda verso l'alto al multiplo specificato
    function roundToMultiple(amount, multiple){
      if (!isFinite(amount) || multiple <= 0) return amount;
      const rem = amount % multiple;
      if (rem === 0) return amount;
      return amount + (multiple - rem);
    }

    // Calcoli per ciascun tipo di evento (senza moltiplicatore M)
    function calcMatrimonio(B,I,C,P,D){
      let base = (B/2 + I) * (C + (C * 0.3)) * P * D;
      // multiplo: 50
      const multiple = 50;
      return roundToMultiple(base, multiple);
    }

    function calcCompleanno(B,I,C,P,D,is18, guestMultiplier){
      let base = (B/2 + I) * C * P * D;
      if (is18) base = base * 1.5;
      // arrotondamenti richiesti:
      // - normale: multipli di 5 (se D < 1.5), 10 se D>=1.5
      // - 18: multipli di 10 (se D < 1.5), 20 se D>=1.5
      let multiple;
      if (is18) multiple = (D >= 1.5) ? 20 : 10;
      else multiple = (D >= 1.5) ? 10 : 5;

      let euro = roundToMultiple(base, multiple);
      return euro * (guestMultiplier || 1);
    }

    function calcBattesimo(B,I,C,P,D){
      let base = (B/2 + I) * (C + (C * 0.1)) * P * D;
      return roundToMultiple(base, 20);
    }

    function calcComunione(B,I,C,P,D){
      let base = (B/2 + I) * (C + (C * 0.05)) * P * D;
      const multiple = (D >= 1.5) ? 50 : 20;
      return roundToMultiple(base, multiple);
    }

    function calcCresima(B,I,C,P,D){
      let base = (B/2 + I) * (C + (C * 0.05)) * P * D;
      const multiple = (D >= 1.5) ? 50 : 20;
      return roundToMultiple(base, multiple);
    }

    // Calcolo del moltiplicatore dai dati invitati (età, lavoro) per compleanni
    function computeGuestMultiplier(guests){
      if (!guests || guests.length === 0) return 1.0;
      let employed = 0, unemployed = 0;
      guests.forEach(g => {
        const age = Number(g.querySelector('.g-age').value) || 0;
        const emp = g.querySelector('.g-emp').checked;
        if (age >= 18){ if (emp) employed++; else unemployed++; }
      });
      const total = guests.length;
      const contrib = 0.1 * employed + 0.05 * unemployed;
      return 1 + (contrib / Math.max(1, total));
    }

    function showResult(text){
      $('result').textContent = 'Risultato: ' + text;
    }

    // UI: gestione lista invitati
    function createGuestRow(){
      const div = document.createElement('div');
      div.className = 'guest-row';
      div.style.marginTop = '6px';
      div.innerHTML = ''
        + 'Età: <input class="g-age" type="number" min="0" value="30" style="width:72px"> '
        + 'Ha lavoro: <input class="g-emp" type="checkbox"> '
        + '<button class="g-del small-btn" type="button">Rimuovi</button>';
      // quando cambia l'età ricalcola B/I
      const ageInput = div.querySelector('.g-age');
      ageInput.addEventListener('change', ()=>{ updateBIFromGuests(); });
      // rimuovi guest e aggiorna
      div.querySelector('.g-del').addEventListener('click', ()=>{ div.remove(); updateBirthdaySection(); updateBIFromGuests(); });
      return div;
    }

    // Aggiorna i campi B e I dai dati degli invitati (soglia 13 anni)
    function updateBIFromGuests(){
      // aggiorna solo se è selezionato un compleanno
      const birthdaySelected = Array.from(document.querySelectorAll('.ev')).some(cb => cb.checked && (cb.value === 'compleanno' || cb.value === 'compleanno18'));
      if (!birthdaySelected) return;

      const guests = Array.from(document.querySelectorAll('#guest-list .guest-row'));
      let children = 0, adults = 0;
      guests.forEach(g => {
        const age = Number(g.querySelector('.g-age').value) || 0;
        if (age < 13) children++; else adults++;
      });
      // aggiorna i campi B (bambini) e I (adulti)
      $('B').value = children;
      $('I').value = adults;
    }

    function updateBirthdaySection(){
      const show = Array.from(document.querySelectorAll('.ev')).some(cb => cb.checked && (cb.value === 'compleanno' || cb.value === 'compleanno18'));
      $('birthday-data').style.display = show ? 'block' : 'none';
    }

    // Forza D minimo 1.2 per certe parentela sensibili
    const sensitiveP = new Set(["1.5","2.0","1.8","1.5"]);
    function enforceDMinima(){
      const pVal = $('P').value;
      const dEl = $('D');
      if (sensitiveP.has(pVal)){
        const currentD = dEl.value ? Number(dEl.value) : 0;
        if (currentD < 1.2){
          let found = false;
          for (let i=0;i<dEl.options.length;i++){
            const v = Number(dEl.options[i].value);
            if (!isNaN(v) && v >= 1.2){ dEl.selectedIndex = i; found = true; break; }
          }
          if (!found){
            const opt = document.createElement('option');
            opt.value = '1.2';
            opt.text = '-- Forzato 1.2 --';
            opt.dataset.temp = '1';
            dEl.appendChild(opt);
            dEl.selectedIndex = dEl.options.length-1;
          }
          showResult('Grado di "Bella Figura" forzato a 1.2 per questa parentela.');
        }
      } else {
        for (let i=dEl.options.length-1;i>=0;i--){
          const o = dEl.options[i];
          if (o.dataset && o.dataset.temp === '1') o.remove();
        }
      }
    }

    // event handlers per aggiungere invitati
  $('add-guest').addEventListener('click', ()=>{ $('guest-list').appendChild(createGuestRow()); updateBIFromGuests(); });
  $('clear-guests').addEventListener('click', ()=>{ $('guest-list').innerHTML = ''; updateBIFromGuests(); });

  // assicurati che la select P scatti la forzatura quando cambia
  $('P').addEventListener('change', ()=>{ enforceDMinima(); });

    // principali listener
    document.querySelectorAll('.ev').forEach(cb => cb.addEventListener('change', ()=>{ updateBirthdaySection(); updateBIFromGuests(); }));

    $('calc').addEventListener('click', ()=>{
      const B = Number($('B').value) || 0;
      const I = Number($('I').value) || 0;
      const C = Number($('C').value) || 0;
      const P = Number($('P').value) || 1;
      const D = Number($('D').value) || 1;

      // raccogli eventi selezionati
      const events = Array.from(document.querySelectorAll('.ev')).filter(cb => cb.checked).map(cb => cb.value);
      if (events.length === 0){ showResult('Seleziona almeno una tipologia di evento.'); return; }

  // enforce minima D e guest multiplier per compleanni
  enforceDMinima();
      const guestElems = Array.from(document.querySelectorAll('#guest-list .guest-row'));
      const guestMultiplier = computeGuestMultiplier(guestElems);

      // calcola il valore pieno per ogni evento
      const fullValues = {};
      events.forEach(ev => {
        let value = 0;
        if (ev === 'matrimonio') value = calcMatrimonio(B,I,C,P,D);
        if (ev === 'battesimo') value = calcBattesimo(B,I,C,P,D);
        if (ev === 'compleanno') value = calcCompleanno(B,I,C,P,D,false,guestMultiplier);
        if (ev === 'compleanno18') value = calcCompleanno(B,I,C,P,D,true,guestMultiplier);
        if (ev === 'comunione') value = calcComunione(B,I,C,P,D);
        if (ev === 'cresima') value = calcCresima(B,I,C,P,D);
        fullValues[ev] = Number(Number(value).toFixed(2));
      });

      // se selezionati più eventi: mantieni pieno il maggiore, dimezza tutti gli altri
      let adjustedValues = {};
      if (events.length === 1){
        adjustedValues = Object.assign({}, fullValues);
      } else {
        // trova il valore massimo (se più valori uguali prende il primo)
        let maxVal = -Infinity;
        let maxKey = null;
        for (const k of events){
          if (fullValues[k] > maxVal){ maxVal = fullValues[k]; maxKey = k; }
        }
        events.forEach(k => {
          if (k === maxKey) adjustedValues[k] = fullValues[k];
          else adjustedValues[k] = Number((fullValues[k] / 2).toFixed(2));
        });
      }

      // sommatoria e arrotondamento finale
      const rawTotal = Object.values(adjustedValues).reduce((s,v)=>s+v,0);

      // arrotondamento finale: se parentela è 'Amico' (P == 1.0) -> multipli di 5, altrimenti multipli di 10
      const pVal = Number($('P').value) || 1;
      const finalMultiple = (pVal === 1.0) ? 5 : 10;
      const totalRounded = roundToMultiple(rawTotal, finalMultiple);

      // mostra breakdown (mostra valore pieno e, se dimezzato, indica)
      let out = '';
      for (const k of events){
        const full = fullValues[k];
        const adj = adjustedValues[k];
        if (adj === full) out += `${k}: €${full.toFixed(2)}\n`;
        else out += `${k}: €${full.toFixed(2)} -> dimezzato -> €${adj.toFixed(2)}\n`;
      }

      out += `\nTotale stimato (dopo dimezzamenti): €${rawTotal.toFixed(2)}`;
      out += `\nTotale arrotondato: €${totalRounded.toFixed(2)} (multiplo di ${finalMultiple})`;

      showResult(out);
    });

    $('reset').addEventListener('click', ()=>{
      $('B').value = 0; $('I').value = 0; $('C').value = 0; $('P').selectedIndex = 0; $('D').selectedIndex = 0; $('guest-list').innerHTML = '';
      document.querySelectorAll('.ev').forEach(cb => cb.checked = false);
      updateBirthdaySection();
      // rimuovi eventuali option temporanee forzate
      const dEl = $('D');
      for (let i=dEl.options.length-1;i>=0;i--){ const o=dEl.options[i]; if (o.dataset && o.dataset.temp === '1') o.remove(); }
      showResult('—');
    });
    // chiude DOMContentLoaded
    });
  </script>
  
</body>
</html>